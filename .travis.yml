dist: xenial
sudo: false
language: scala

before_install:
- git fetch --tags

before_cache:
- rm -fv $HOME/.ivy2/.sbt.ivy.lock
- find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
- find $HOME/.sbt        -name "*.lock"               -print -delete

sbt_args: -Dfile.encoding=UTF8 -Dsbt.color=always -Dsbt.supershell=false

stages:
- name: format-check
  if: tag IS NOT present
- name: setup
  if: tag IS NOT present
- name: test
  if: tag IS NOT present
- name: codecov-upload
  if: tag IS NOT present
- name: release-212
  if: branch = master AND tag IS present AND NOT fork
- name: release-213
  if: branch = master AND tag IS present AND NOT fork
- name: cleanup
  if: tag IS NOT present

scala:
- 2.12.11
- 2.13.2
jdk:
- openjdk8
- openjdk13

script: sbt ++$TRAVIS_SCALA_VERSION fullTest

jobs:
  include:
  - stage: setup
    name: Docker setup
    script:
    - docker run -p 6379:6379 -d redis:alpine
    - docker run -p 6380:6379 -d eqalpha/keydb
    jdk: openjdk8
    scala: 2.13.2

  - stage: format-check
    name: Check with Scalafmt
    script: sbt ++$TRAVIS_SCALA_VERSION fmtCheck
    jdk: openjdk8
    scala: 2.13.2

  - stage: codecov-upload
    name: Upload Codecov results
    script: bash <(curl -s https://codecov.io/bash)
    jdk: openjdk8
    scala: 2.13.2

  - stage: release-212
    name: Release for Scala 2.12
    script: sbt ++$TRAVIS_SCALA_VERSION releaseIt
    jdk: openjdk8
    scala: 2.13.2

  - stage: release-213
    name: Release for Scala 2.13
    script: sbt ++$TRAVIS_SCALA_VERSION releaseIt
    jdk: openjdk8
    scala: 2.13.2

  - stage: cleanup
    name: Docker shutdown
    script: docker stop $(docker ps -a -q)
    jdk: openjdk8
    scala: 2.13.2

services:
- docker

cache:
  directories:
  - "$HOME/.cache/coursier"
  - "$HOME/.ivy2/cache"
  - "$HOME/.sbt/boot/"
  - "$HOME/.sbt"
  - "lib_managed"
  - "target"
  - "project/target"
